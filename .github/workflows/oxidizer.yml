name: oxidizer

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      total_days:
        description: 'Total days for initialization (only used on first run)'
        required: false
        default: '3650'

permissions:
  contents: write

jobs:
  oxidize:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Initialize if needed
        run: |
          TOTAL="${{ github.event.inputs.total_days || '3650' }}"
          METAL="self/metal.metal"
          RUST="self/rust.rs"

          # Only initialize if files don't exist or are empty
          if [ ! -f "$METAL" ] || [ ! -s "$METAL" ]; then
            echo "Initializing with $TOTAL lines..."
            printf '#%.0s\n' $(seq 1 "$TOTAL") > "$METAL"
            : > "$RUST"
          fi

      - name: Oxidize
        run: |
          METAL="self/metal.metal"
          RUST="self/rust.rs"

          REMAINING=$(wc -l < "$METAL" | tr -d ' ')
          if [ "$REMAINING" -eq 0 ]; then
            echo "âœ“ Fully oxidized. Process complete."
            exit 0
          fi

          # Remove last line from metal, append to rust
          head -n -1 "$METAL" > "$METAL.tmp" && mv "$METAL.tmp" "$METAL"
          echo '#' >> "$RUST"

          # Update counts
          METAL_LINES=$(wc -l < "$METAL" | tr -d ' ')
          RUST_LINES=$(wc -l < "$RUST" | tr -d ' ')
          TOTAL=$((METAL_LINES + RUST_LINES))
          PCT=$(awk "BEGIN {printf \"%.1f\", ($RUST_LINES/$TOTAL)*100}")

          # Update README Status section
          sed -i "s|Oxidation: .*%|Oxidation: ${PCT}%|" README.md
          sed -i "s|Metal: .* lines|Metal: ${METAL_LINES} lines|" README.md
          sed -i "s|Rust: .* lines|Rust: ${RUST_LINES} lines|" README.md

          # Update Latest Deployment section with progress
          if grep -q "## Latest Deployment" README.md; then
            # Update "Days elapsed" line if it exists, otherwise add it
            if grep -q "Days elapsed:" README.md; then
              sed -i "s|Days elapsed: .*|Days elapsed: ${RUST_LINES}/${TOTAL}|" README.md
            else
              sed -i "/Expected completion:/a\\
- Days elapsed: ${RUST_LINES}/${TOTAL}" README.md
            fi
          fi

          echo "Oxidation progress: ${PCT}% (${RUST_LINES}/${TOTAL} days)"

      - name: Commit
        run: |
          git config user.name "oxidizer[bot]"
          git config user.email "oxidizer[bot]@users.noreply.github.com"
          git add self/ README.md
          git diff --cached --quiet && exit 0
          git commit -m "oxidize: another day passes"
          git push

name: Update README on Deploy

on:
  deployment_status:

permissions:
  contents: write

jobs:
  update-readme:
    if: github.event.deployment_status.state == 'success' && github.event.deployment_status.environment == 'Production'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - name: Initialize and update README
        env:
          TARGET_DAY: ${{ secrets.TARGET_DAY }}
        run: |
          DEPLOY_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          DEPLOY_URL="${{ github.event.deployment_status.target_url }}"

          # Use TARGET_DAY from GitHub Secrets
          TOTAL_DAYS="${TARGET_DAY:-365}"
          TOTAL_LINES=$(printf "%.0f" "$TOTAL_DAYS")
          [ "$TOTAL_LINES" -lt 1 ] && TOTAL_LINES=1

          # Initialize metal.metal with # symbols and rust.rs as empty
          printf '#%.0s\n' $(seq 1 "$TOTAL_LINES") > self/metal.metal
          > self/rust.rs

          # Calculate end date
          END_DATE=$(date -u -d "+${TOTAL_DAYS} days" +"%Y-%m-%d" 2>/dev/null || echo "N/A")

          # Update Status section in README
          sed -i "s|Oxidation: .*%|Oxidation: 0.0%|" README.md
          sed -i "s|Metal: .* lines|Metal: ${TOTAL_LINES} lines|" README.md
          sed -i "s|Rust: .* lines|Rust: 0 lines|" README.md

          # Update language composition bar (80 chars total)
          METAL_BAR="████████████████████████████████████████████████████████████████████████████████"
          sed -i "/^████/c\\${METAL_BAR}" README.md
          sed -i "s|^Metal: .*%.*Rust: .*%.*$|Metal: 100.0%                                                        Rust: 0.0%|" README.md

          # Update or add deployment info section
          cat > /tmp/deployment_info.txt <<EOF
          ## Latest Deployment

          - Time: ${DEPLOY_TIME}
          - URL: ${DEPLOY_URL}
          - Duration: ${TOTAL_DAYS} days (${TOTAL_LINES} iterations)
          - Expected completion: ${END_DATE}
          EOF

          if grep -q "## Latest Deployment" README.md; then
            # Remove old deployment section
            sed -i '/## Latest Deployment/,/^## /{/^## Latest Deployment/!{/^## /!d;}}' README.md
            # Insert new deployment info after "## Latest Deployment"
            sed -i '/## Latest Deployment/r /tmp/deployment_info.txt' README.md
            sed -i '/## Latest Deployment/{n;d;}' README.md
          else
            # Add after Status section
            sed -i '/## Status/r /tmp/deployment_info.txt' README.md
          fi

      - name: Commit changes
        run: |
          git config user.name "deploy-bot[bot]"
          git config user.email "deploy-bot[bot]@users.noreply.github.com"
          git add self/ README.md
          git diff --cached --quiet && exit 0
          git commit -m "deploy: initialize oxidation process [skip ci]"
          git push

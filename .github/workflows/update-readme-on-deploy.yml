name: Update README on Deploy

on:
  deployment_status:

permissions:
  contents: write

jobs:
  update-readme:
    if: github.event.deployment_status.state == 'success' && github.event.deployment_status.environment == 'Production'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - name: Initialize and update README
        env:
          TARGET_DAY: ${{ secrets.TARGET_DAY }}
        run: |
          DEPLOY_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          DEPLOY_URL="${{ github.event.deployment_status.target_url }}"

          # Use TARGET_DAY from GitHub Secrets
          TOTAL_DAYS="${TARGET_DAY:-365}"
          TOTAL_LINES=$(printf "%.0f" "$TOTAL_DAYS")
          [ "$TOTAL_LINES" -lt 1 ] && TOTAL_LINES=1

          # Initialize metal.metal with # symbols and rust.rs as empty
          printf '#%.0s\n' $(seq 1 "$TOTAL_LINES") > self/metal.metal
          > self/rust.rs

          # Calculate end date
          END_DATE=$(date -u -d "+${TOTAL_DAYS} days" +"%Y-%m-%d" 2>/dev/null || echo "N/A")

          # Rebuild entire Status section with initial values
          METAL_BAR="████████████████████████████████████████████████████████████████████████████████"
          awk -v total="${TOTAL_LINES}" -v bar="${METAL_BAR}" '
          /^## Status$/ {
            print "## Status"
            print ""
            print "- Oxidation: 0.0%"
            print "- Metal: " total " lines"
            print "- Rust: 0 lines"
            print ""
            print "### Language Composition"
            print "```"
            print bar
            print "Metal: 100.0%                                                        Rust: 0.0%"
            print "```"
            skip=1
            next
          }
          /^## / && skip { skip=0 }
          !skip { print }
          ' README.md > README.md.tmp && mv README.md.tmp README.md

          # Remove old deployment section if exists (from ## Latest Deployment to next ##)
          if grep -q "## Latest Deployment" README.md; then
            awk '
            /^## Latest Deployment$/ { skip=1; next }
            /^## / && skip { skip=0 }
            !skip { print }
            ' README.md > README.md.tmp && mv README.md.tmp README.md
          fi

          # Insert deployment info after the closing ``` of Language Composition
          awk -v deploy_time="${DEPLOY_TIME}" -v deploy_url="${DEPLOY_URL}" -v total_days="${TOTAL_DAYS}" -v total_lines="${TOTAL_LINES}" -v end_date="${END_DATE}" '
          /^```$/ && in_composition && !inserted {
            print
            print ""
            print "## Latest Deployment"
            print ""
            print "- Time: " deploy_time
            print "- URL: " deploy_url
            print "- Duration: " total_days " days (" total_lines " iterations)"
            print "- Expected completion: " end_date
            inserted=1
            next
          }
          /### Language Composition/ { in_composition=1 }
          { print }
          ' README.md > README.md.tmp && mv README.md.tmp README.md

      - name: Commit changes
        run: |
          git config user.name "deploy-bot[bot]"
          git config user.email "deploy-bot[bot]@users.noreply.github.com"
          git add self/ README.md
          git diff --cached --quiet && exit 0
          git commit -m "deploy: initialize oxidation process [skip ci]"
          git push
